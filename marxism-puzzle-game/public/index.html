<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>â˜­ Marxism-Leninism Puzzle Game</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Socket.io Client -->
    <script src="/socket.io/socket.io.js"></script>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'soviet-red': '#CC0000',
                        'soviet-gold': '#FFD700',
                        'soviet-dark': '#1a0a0a',
                        'soviet-darker': '#0d0505',
                    },
                    fontFamily: {
                        'bebas': ['Bebas Neue', 'sans-serif'],
                        'roboto': ['Roboto', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <style>
        body {
            background: linear-gradient(135deg, #1a0a0a 0%, #2d0a0a 50%, #1a0a0a 100%);
            font-family: 'Roboto', sans-serif;
        }
        
        .soviet-border {
            border: 3px solid #CC0000;
            box-shadow: 0 0 20px rgba(204, 0, 0, 0.3), inset 0 0 20px rgba(204, 0, 0, 0.1);
        }
        
        .gold-glow {
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5), 0 0 20px rgba(255, 215, 0, 0.3);
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 40px rgba(204, 0, 0, 0.4);
        }
        
        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 20px rgba(204, 0, 0, 0.5); }
            50% { box-shadow: 0 0 40px rgba(204, 0, 0, 0.8); }
        }
        
        @keyframes flash-green {
            0%, 100% { background-color: rgba(34, 197, 94, 0.2); }
            50% { background-color: rgba(34, 197, 94, 0.5); }
        }
        
        @keyframes flash-red {
            0%, 100% { background-color: rgba(239, 68, 68, 0.2); }
            50% { background-color: rgba(239, 68, 68, 0.5); }
        }
        
        .flash-success {
            animation: flash-green 0.5s ease-in-out 3;
        }
        
        .flash-error {
            animation: flash-red 0.3s ease-in-out 2;
        }
        
        .waiting-pulse {
            animation: pulse-red 2s infinite;
        }
        
        .icon-large {
            font-size: 4rem;
        }
        
        .hammer-sickle {
            font-size: 5rem;
            color: #FFD700;
        }
        
        /* Decorative star corners */
        .star-corner::before,
        .star-corner::after {
            content: 'â˜…';
            position: absolute;
            color: #FFD700;
            font-size: 1.5rem;
        }
        
        .star-corner::before {
            top: 10px;
            left: 10px;
        }
        
        .star-corner::after {
            top: 10px;
            right: 10px;
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #1a0a0a;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #CC0000;
            border-radius: 4px;
        }
        
        /* Chat styling */
        .chat-message {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body class="min-h-screen text-white">
    
    <!-- ==================== LOBBY SCREEN ==================== -->
    <div id="lobbyScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="soviet-border rounded-lg p-8 max-w-md w-full bg-soviet-darker/80 backdrop-blur star-corner relative">
            <div class="text-center">
                <h1 class="font-bebas text-5xl text-soviet-gold gold-glow mb-2">â˜­ UNITY PUZZLE â˜­</h1>
                <p class="text-gray-400 mb-6">Marxism-Leninism Educational Game</p>
                
                <div class="mb-8">
                    <div class="hammer-sickle mb-4">â˜­</div>
                    <p class="text-sm text-gray-300 italic">"Workers of the world, unite!"</p>
                </div>
                
                <div class="bg-soviet-dark/50 rounded-lg p-4 mb-6 text-left">
                    <h3 class="text-soviet-gold font-bold mb-2"><i class="fas fa-info-circle mr-2"></i>How to Play:</h3>
                    <ul class="text-sm text-gray-300 space-y-2">
                        <li><i class="fas fa-user text-soviet-red mr-2"></i><strong>The Guide:</strong> Sees theory & questions</li>
                        <li><i class="fas fa-user-cog text-soviet-gold mr-2"></i><strong>The Agent:</strong> Sees images & buttons</li>
                        <li><i class="fas fa-comments text-green-400 mr-2"></i><strong>Communicate:</strong> Talk to solve puzzles!</li>
                    </ul>
                </div>
                
                <button id="joinBtn" onclick="joinGame()" 
                    class="w-full bg-soviet-red hover:bg-red-700 text-white font-bold py-4 px-8 rounded-lg 
                           transition-all duration-300 transform hover:scale-105 
                           shadow-lg hover:shadow-red-500/50 text-xl">
                    <i class="fas fa-play mr-2"></i>JOIN GAME
                </button>
            </div>
        </div>
    </div>
    
    <!-- ==================== WAITING SCREEN ==================== -->
    <div id="waitingScreen" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="soviet-border rounded-lg p-8 max-w-md w-full bg-soviet-darker/80 backdrop-blur waiting-pulse text-center">
            <div class="hammer-sickle mb-4 animate-pulse">â˜­</div>
            <h2 class="font-bebas text-3xl text-soviet-gold mb-4">WAITING FOR COMRADE...</h2>
            <p class="text-gray-300 mb-4">You have been assigned as:</p>
            <div id="waitingRole" class="text-2xl font-bold text-soviet-gold mb-6"></div>
            <div class="flex items-center justify-center space-x-2">
                <div class="w-3 h-3 bg-soviet-red rounded-full animate-bounce" style="animation-delay: 0s;"></div>
                <div class="w-3 h-3 bg-soviet-gold rounded-full animate-bounce" style="animation-delay: 0.2s;"></div>
                <div class="w-3 h-3 bg-soviet-red rounded-full animate-bounce" style="animation-delay: 0.4s;"></div>
            </div>
            <p class="text-sm text-gray-500 mt-4">Room ID: <span id="roomIdDisplay" class="text-soviet-gold"></span></p>
        </div>
    </div>
    
    <!-- ==================== GAME SCREEN ==================== -->
    <div id="gameScreen" class="hidden min-h-screen p-4">
        <!-- Header -->
        <header class="soviet-border rounded-lg p-4 mb-4 bg-soviet-darker/80 backdrop-blur">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div class="flex items-center space-x-4">
                    <span class="text-4xl">â˜­</span>
                    <div>
                        <h1 class="font-bebas text-2xl text-soviet-gold">LEVEL <span id="levelNumber">1</span></h1>
                        <p class="text-sm text-gray-400" id="themeDisplay"></p>
                    </div>
                </div>
                <div class="flex items-center space-x-6">
                    <div class="text-center">
                        <p class="text-xs text-gray-400">ROLE</p>
                        <p id="roleDisplay" class="font-bold text-soviet-gold"></p>
                    </div>
                    <div class="text-center">
                        <p class="text-xs text-gray-400">ATTEMPTS</p>
                        <p id="attemptsDisplay" class="font-bold text-white">3/3</p>
                    </div>
                    <div class="text-center">
                        <p class="text-xs text-gray-400">SCORE</p>
                        <p id="scoreDisplay" class="font-bold text-soviet-gold">0</p>
                    </div>
                </div>
            </div>
        </header>
        
        <div class="grid lg:grid-cols-3 gap-4">
            <!-- Main Game Area -->
            <div class="lg:col-span-2">
                <!-- Guide View (Player A) -->
                <div id="guideView" class="hidden">
                    <div class="soviet-border rounded-lg p-6 bg-soviet-darker/80 backdrop-blur">
                        <div class="flex items-center mb-4">
                            <i class="fas fa-book-open text-soviet-gold text-2xl mr-3"></i>
                            <h2 class="font-bebas text-2xl text-soviet-gold">THE THEORY</h2>
                        </div>
                        
                        <div class="bg-soviet-dark/50 rounded-lg p-4 mb-4">
                            <h3 class="text-soviet-red font-bold mb-2 flex items-center">
                                <i class="fas fa-crosshairs mr-2"></i>TARGET:
                            </h3>
                            <p id="targetText" class="text-lg text-white"></p>
                        </div>
                        
                        <div class="bg-soviet-dark/50 rounded-lg p-4 mb-4">
                            <h3 class="text-soviet-gold font-bold mb-2 flex items-center">
                                <i class="fas fa-lightbulb mr-2"></i>HINT:
                            </h3>
                            <p id="hintText" class="text-lg text-gray-300"></p>
                        </div>
                        
                        <div class="bg-soviet-dark/50 rounded-lg p-4">
                            <h3 class="text-green-400 font-bold mb-2 flex items-center">
                                <i class="fas fa-info-circle mr-2"></i>ADDITIONAL INFO:
                            </h3>
                            <p id="additionalInfoText" class="text-gray-400 italic"></p>
                        </div>
                        
                        <div class="mt-6 p-4 bg-yellow-900/30 border border-yellow-600 rounded-lg">
                            <p class="text-yellow-400 text-sm flex items-center">
                                <i class="fas fa-exclamation-triangle mr-2"></i>
                                <strong>GUIDE ROLE:</strong> You can ONLY see the theory. Communicate with your Agent partner!
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Agent View (Player B) -->
                <div id="agentView" class="hidden">
                    <div class="soviet-border rounded-lg p-6 bg-soviet-darker/80 backdrop-blur">
                        <div class="flex items-center mb-4">
                            <i class="fas fa-hand-pointer text-soviet-gold text-2xl mr-3"></i>
                            <h2 class="font-bebas text-2xl text-soviet-gold">THE PRACTICE</h2>
                        </div>
                        
                        <p class="text-gray-300 mb-6">Listen to your Guide and select the correct symbol:</p>
                        
                        <div id="optionsGrid" class="grid grid-cols-2 gap-4">
                            <!-- Options will be inserted here -->
                        </div>
                        
                        <div class="mt-6 p-4 bg-blue-900/30 border border-blue-600 rounded-lg">
                            <p class="text-blue-400 text-sm flex items-center">
                                <i class="fas fa-exclamation-triangle mr-2"></i>
                                <strong>AGENT ROLE:</strong> You can ONLY see the symbols. Listen to your Guide partner!
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Result Display -->
                <div id="resultDisplay" class="hidden mt-4">
                    <div id="resultBox" class="soviet-border rounded-lg p-6 bg-soviet-darker/80 backdrop-blur text-center">
                        <div id="resultIcon" class="text-6xl mb-4"></div>
                        <h3 id="resultTitle" class="font-bebas text-3xl mb-2"></h3>
                        <p id="resultMessage" class="text-lg mb-4"></p>
                        <p id="resultExplanation" class="text-gray-400 italic text-sm"></p>
                        <button id="restartBtn" onclick="restartLevel()" 
                            class="hidden mt-4 bg-soviet-gold hover:bg-yellow-600 text-black font-bold py-2 px-6 rounded-lg transition-all">
                            <i class="fas fa-redo mr-2"></i>Play Again
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Chat Panel -->
            <div class="lg:col-span-1">
                <div class="soviet-border rounded-lg bg-soviet-darker/80 backdrop-blur h-full flex flex-col">
                    <div class="p-4 border-b border-soviet-red/30">
                        <h3 class="font-bebas text-xl text-soviet-gold flex items-center">
                            <i class="fas fa-comments mr-2"></i>COMRADE CHAT
                        </h3>
                    </div>
                    
                    <div id="chatMessages" class="flex-1 p-4 overflow-y-auto max-h-96 space-y-2">
                        <div class="text-center text-gray-500 text-sm">
                            <p>ðŸ’¬ Use voice chat or type messages to communicate!</p>
                        </div>
                    </div>
                    
                    <div class="p-4 border-t border-soviet-red/30">
                        <div class="flex space-x-2">
                            <input type="text" id="chatInput" placeholder="Type a message..." 
                                class="flex-1 bg-soviet-dark border border-soviet-red/50 rounded-lg px-4 py-2 
                                       text-white placeholder-gray-500 focus:outline-none focus:border-soviet-gold"
                                onkeypress="handleChatKeypress(event)">
                            <button onclick="sendChatMessage()" 
                                class="bg-soviet-red hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-all">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ==================== GAME OVER SCREEN ==================== -->
    <div id="gameOverScreen" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="soviet-border rounded-lg p-8 max-w-md w-full bg-soviet-darker/80 backdrop-blur text-center">
            <div class="text-6xl mb-4">ðŸ’”</div>
            <h2 class="font-bebas text-4xl text-soviet-red mb-4">GAME OVER</h2>
            <p id="gameOverMessage" class="text-gray-300 mb-4"></p>
            <p class="text-soviet-gold text-2xl mb-6">Final Score: <span id="finalScore">0</span></p>
            <button onclick="restartLevel()" 
                class="bg-soviet-gold hover:bg-yellow-600 text-black font-bold py-3 px-8 rounded-lg transition-all text-lg">
                <i class="fas fa-redo mr-2"></i>TRY AGAIN
            </button>
        </div>
    </div>
    
    <!-- ==================== DISCONNECTED OVERLAY ==================== -->
    <div id="disconnectedOverlay" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50">
        <div class="soviet-border rounded-lg p-8 max-w-md w-full bg-soviet-darker text-center">
            <div class="text-6xl mb-4">ðŸ˜¢</div>
            <h2 class="font-bebas text-3xl text-soviet-red mb-4">COMRADE DISCONNECTED</h2>
            <p class="text-gray-300 mb-6">Your partner has left the game. Waiting for a new comrade...</p>
            <div class="flex items-center justify-center space-x-2">
                <div class="w-3 h-3 bg-soviet-red rounded-full animate-bounce" style="animation-delay: 0s;"></div>
                <div class="w-3 h-3 bg-soviet-gold rounded-full animate-bounce" style="animation-delay: 0.2s;"></div>
                <div class="w-3 h-3 bg-soviet-red rounded-full animate-bounce" style="animation-delay: 0.4s;"></div>
            </div>
        </div>
    </div>
    
    <!-- ==================== JAVASCRIPT ==================== -->
    <script>
        // Socket connection
        const socket = io();
        
        // Game state
        let currentRole = null;
        let currentRoomId = null;
        let maxAttempts = 3;
        let currentAttempts = 0;
        let score = 0;
        
        // DOM Elements
        const screens = {
            lobby: document.getElementById('lobbyScreen'),
            waiting: document.getElementById('waitingScreen'),
            game: document.getElementById('gameScreen'),
            gameOver: document.getElementById('gameOverScreen')
        };
        
        // Show specific screen
        function showScreen(screenName) {
            Object.values(screens).forEach(screen => screen.classList.add('hidden'));
            screens[screenName].classList.remove('hidden');
        }
        
        // Join game
        function joinGame() {
            socket.emit('joinGame');
            document.getElementById('joinBtn').disabled = true;
            document.getElementById('joinBtn').innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>CONNECTING...';
        }
        
        // Handle role assignment
        socket.on('roleAssigned', (data) => {
            currentRole = data.role;
            currentRoomId = data.roomId;
            
            document.getElementById('roomIdDisplay').textContent = data.roomId;
            
            const roleText = data.role === 'guide' ? 'ðŸ“– THE GUIDE (Player A)' : 'ðŸŽ¯ THE AGENT (Player B)';
            document.getElementById('waitingRole').textContent = roleText;
            
            if (data.waiting) {
                showScreen('waiting');
            }
        });
        
        // Handle game start
        socket.on('gameStart', (data) => {
            showScreen('game');
            
            // Update header info
            document.getElementById('levelNumber').textContent = data.level;
            document.getElementById('themeDisplay').textContent = `${data.theme} (${data.themeVi})`;
            document.getElementById('roleDisplay').textContent = data.role === 'guide' ? 'THE GUIDE' : 'THE AGENT';
            document.getElementById('attemptsDisplay').textContent = `${data.maxAttempts}/${data.maxAttempts}`;
            
            maxAttempts = data.maxAttempts;
            currentAttempts = 0;
            
            // Show appropriate view
            document.getElementById('guideView').classList.add('hidden');
            document.getElementById('agentView').classList.add('hidden');
            document.getElementById('resultDisplay').classList.add('hidden');
            
            if (data.role === 'guide') {
                setupGuideView(data.guideInfo);
            } else {
                setupAgentView(data.options);
            }
        });
        
        // Setup Guide View
        function setupGuideView(guideInfo) {
            document.getElementById('guideView').classList.remove('hidden');
            document.getElementById('targetText').textContent = guideInfo.target;
            document.getElementById('hintText').textContent = guideInfo.hint;
            document.getElementById('additionalInfoText').textContent = guideInfo.additionalInfo;
        }
        
        // Setup Agent View
        function setupAgentView(options) {
            document.getElementById('agentView').classList.remove('hidden');
            const grid = document.getElementById('optionsGrid');
            grid.innerHTML = '';
            
            options.forEach(option => {
                const card = document.createElement('button');
                card.className = `
                    soviet-border rounded-lg p-6 bg-soviet-dark/50 
                    card-hover cursor-pointer text-center
                    hover:bg-soviet-red/20 transition-all duration-300
                    focus:outline-none focus:ring-2 focus:ring-soviet-gold
                `;
                card.onclick = () => submitAnswer(option.id);
                
                card.innerHTML = `
                    <div class="text-5xl mb-3">${option.icon}</div>
                    <p class="text-sm text-gray-300">${option.label}</p>
                `;
                
                grid.appendChild(card);
            });
        }
        
        // Submit answer
        function submitAnswer(answerId) {
            socket.emit('submitAnswer', { answerId });
            
            // Disable all buttons while waiting
            document.querySelectorAll('#optionsGrid button').forEach(btn => {
                btn.disabled = true;
                btn.classList.add('opacity-50');
            });
        }
        
        // Handle answer result
        socket.on('answerResult', (result) => {
            const resultDisplay = document.getElementById('resultDisplay');
            const resultBox = document.getElementById('resultBox');
            const gameScreen = document.getElementById('gameScreen');
            
            resultDisplay.classList.remove('hidden');
            
            if (result.correct) {
                // Success!
                resultBox.className = 'soviet-border rounded-lg p-6 bg-green-900/30 border-green-500 backdrop-blur text-center flash-success';
                document.getElementById('resultIcon').textContent = 'âœ…';
                document.getElementById('resultTitle').textContent = 'VICTORY!';
                document.getElementById('resultTitle').className = 'font-bebas text-3xl mb-2 text-green-400';
                document.getElementById('resultMessage').textContent = result.message;
                document.getElementById('resultExplanation').textContent = result.explanation;
                document.getElementById('restartBtn').classList.remove('hidden');
                
                score = result.score;
                document.getElementById('scoreDisplay').textContent = score;
                
                // Flash green
                gameScreen.classList.add('flash-success');
                setTimeout(() => gameScreen.classList.remove('flash-success'), 1500);
                
            } else {
                // Wrong answer
                currentAttempts++;
                document.getElementById('attemptsDisplay').textContent = `${maxAttempts - currentAttempts}/${maxAttempts}`;
                
                resultBox.className = 'soviet-border rounded-lg p-6 bg-red-900/30 border-red-500 backdrop-blur text-center flash-error';
                document.getElementById('resultIcon').textContent = 'âŒ';
                document.getElementById('resultTitle').textContent = 'INCORRECT!';
                document.getElementById('resultTitle').className = 'font-bebas text-3xl mb-2 text-red-400';
                document.getElementById('resultMessage').textContent = result.message;
                document.getElementById('resultExplanation').textContent = `Attempts remaining: ${result.attemptsLeft}`;
                
                // Flash red
                gameScreen.classList.add('flash-error');
                setTimeout(() => {
                    gameScreen.classList.remove('flash-error');
                    
                    if (!result.gameOver) {
                        // Re-enable buttons
                        document.querySelectorAll('#optionsGrid button').forEach(btn => {
                            btn.disabled = false;
                            btn.classList.remove('opacity-50');
                        });
                        
                        // Hide result after delay
                        setTimeout(() => {
                            resultDisplay.classList.add('hidden');
                        }, 2000);
                    }
                }, 600);
            }
        });
        
        // Handle game over
        socket.on('gameOver', (data) => {
            showScreen('gameOver');
            document.getElementById('gameOverMessage').textContent = data.message;
            document.getElementById('finalScore').textContent = data.finalScore;
        });
        
        // Restart level
        function restartLevel() {
            socket.emit('restartLevel');
            document.getElementById('resultDisplay').classList.add('hidden');
            document.getElementById('restartBtn').classList.add('hidden');
        }
        
        // Handle partner disconnection
        socket.on('partnerDisconnected', (data) => {
            document.getElementById('disconnectedOverlay').classList.remove('hidden');
        });
        
        // Handle reconnection (partner joined)
        socket.on('gameStart', () => {
            document.getElementById('disconnectedOverlay').classList.add('hidden');
        });
        
        // Chat functionality
        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (message) {
                // Add own message
                addChatMessage('You', message, true);
                
                // Send to partner
                socket.emit('chatMessage', message);
                
                input.value = '';
            }
        }
        
        function handleChatKeypress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }
        
        socket.on('chatMessage', (data) => {
            const roleName = data.from === 'guide' ? 'Guide' : 'Agent';
            addChatMessage(roleName, data.message, false);
        });
        
        function addChatMessage(sender, message, isOwn) {
            const chatMessages = document.getElementById('chatMessages');
            const msgDiv = document.createElement('div');
            msgDiv.className = `chat-message p-2 rounded-lg ${isOwn ? 'bg-soviet-red/30 ml-8' : 'bg-soviet-gold/20 mr-8'}`;
            msgDiv.innerHTML = `
                <p class="text-xs ${isOwn ? 'text-soviet-red' : 'text-soviet-gold'} font-bold">${sender}</p>
                <p class="text-sm text-white">${escapeHtml(message)}</p>
            `;
            chatMessages.appendChild(msgDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Utility: Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Handle connection error
        socket.on('connect_error', () => {
            alert('Connection error! Please refresh the page.');
        });
        
        // Handle error
        socket.on('error', (data) => {
            console.error('Server error:', data.message);
        });
    </script>
</body>
</html>
